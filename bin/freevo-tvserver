#! /usr/bin/python
# -*- coding: iso-8859-1 -*-
# -----------------------------------------------------------------------------
# recordserver.py - start script for the recordserver
# -----------------------------------------------------------------------------
# $Id$
#
# This is the freevo tvserver (including epg server)
#
# -----------------------------------------------------------------------------
# Freevo - A Home Theater PC framework
# Copyright (C) 2002-2005 Krister Lagerstrom, Dirk Meyer, et al.
#
# Maintainer:    Dirk Meyer <dischi@freevo.org>
#
# Please see the file doc/CREDITS for a complete list of authors.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MER-
# CHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#
# -----------------------------------------------------------------------------

# python imports
import os
import time
import sys
import logging

# insert freevo path information
__site__ = '../lib/python%s.%s/site-packages' % sys.version_info[:2]
__site__ = os.path.normpath(os.path.join(os.path.dirname(__file__), __site__))
if not __site__ in sys.path:
    sys.path.insert(0, __site__)

# fix possible path problems (it crashes on some python installations)
if os.path.dirname(__file__) in sys.path:
    sys.path.remove(os.path.dirname(__file__))

pid = -1
if len(sys.argv) == 1:
    # Normal recordserver startup, fork epg client. We can not import kaa before
    # forking or the notifier will fail because the internal thread wakeup is
    # handled by two different processes.
    pid = os.fork()

if not pid:
    # This is the epg server. Import everything we need and start it

    # kaa imports
    import kaa
    import kaa.epg

    # freevo core imports
    import freevo.conf

    # read the config file
    from freevo.tvserver.config import config

    # logger setup
    log = logging.getLogger()
    log.setLevel(logging.INFO)

    # remove handler, we want to set the look and avoid
    # duplicate handlers
    for l in log.handlers:
        log.removeHandler(l)

    handler = logging.FileHandler('%s/tvepg-%s' % (freevo.conf.LOGDIR, os.getuid()))
    handler.setFormatter(freevo.conf.formatter)
    log.addHandler(handler)

    # get logging object
    log = logging.getLogger('record')

    # set basic recording debug to info
    log.setLevel(getattr(logging, config.loglevel))

    guide = kaa.epg.Server(str(config.epg.database))

    # run epg server
    kaa.main()

    # print debug at the end
    log.info('terminate epg')
    sys.exit(0)



# At this point we are the main tvserver

# kaa imports
import kaa
import kaa.epg

# freevo core imports
import freevo.conf
import freevo.ipc

# get logging object
log = logging.getLogger('record')

if len(sys.argv) > 1:

    if sys.argv[1] == '-i':
        # import interactive mode
        from freevo.tvserver import interactive

        kaa.main()
        sys.exit(0)

    sys.exit(1)


# get logging object
log = logging.getLogger('record')

def start():
    """
    Start tvserver.
    """
    # import config. At this point we are conncted to the epg. This also means that
    # the epg server already opened the config file and maybe wrote it.
    from freevo.tvserver.config import config

    # set basic recording debug to info
    log.setLevel(getattr(logging, config.loglevel))

    # import recordserver
    from freevo.tvserver.server import RecordServer

    # start recordserver
    server = RecordServer()

    # get mbus address for epg settings
    mbus = freevo.ipc.Instance('tvserver')

    auth = mbus.cfg.hashkey.strip()
    host = mbus.addr['id'][mbus.addr['id'].find('@')+1:]
    port = epg.server.rpc('server.start', 'blocking')(host + ':0', auth)[1]

    # make epg information public
    server.epgaddr = (host, port)


# connect to the epg at client side
num_trys = 1000
while num_trys:
    num_trys -= 1
    try:
        epg = kaa.epg.connect('epg')
        epg.signals['connected'].connect_once(start)
        break
    except Exception, e:
        if not num_trys:
            log.exception('')
            sys.exit(1)
        if os.waitpid(pid, os.WNOHANG)[0] == pid:
            log.error('unable to start epg server')
            sys.exit(1)
        time.sleep(0.01)

kaa.main()

# kill epg server
# FIXME: make sure the server stops itself when the tvserver is gone
os.kill(pid, 15)

# print debug at the end
log.info('terminate')
