#! /usr/bin/python
# -*- coding: iso-8859-1 -*-
# -----------------------------------------------------------------------------
# freevo-tvserver.py - start script for the tvserver
# -----------------------------------------------------------------------------
# $Id$
#
# This is the freevo tvserver (including epg server)
#
# -----------------------------------------------------------------------------
# Freevo - A Home Theater PC framework
# Copyright (C) 2004-2008 Dirk Meyer, et al.
#
# Maintainer:    Dirk Meyer <dischi@freevo.org>
#
# Please see the file AUTHORS for a complete list of authors.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MER-
# CHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#
# -----------------------------------------------------------------------------

# python imports
import os
import time
import sys
import getopt
import logging

# get logging object
log = logging.getLogger('tvserver')

# insert freevo path information
__site__ = '../lib/python%s.%s/site-packages' % sys.version_info[:2]
__site__ = os.path.abspath(os.path.join(os.path.dirname(__file__), __site__))
if not __site__ in sys.path:
    sys.path.insert(0, __site__)

# fix possible path problems (it crashes on some python installations)
if os.path.dirname(__file__) in sys.path:
    sys.path.remove(os.path.dirname(__file__))

# kaa imports
import kaa
import kaa.utils

# read the config file
from freevo.tvserver.config import config

def usage(error_code):
    print 'freevo-tvserver [options]'
    print 'options:'
    print '--fg                start tvserver in foreground'
    print '--stop              stop running tvserver'
    print '--help | -h         this message'
    sys.exit(error_code)


try:
    opts = [ 'fg', 'stop', 'help' ]
    opts, args = getopt.getopt(sys.argv[1:], 'h', opts)
except getopt.GetoptError:
    usage(1)


detach = True
for o, a in opts:
    if o == '--fg':
        detach = False

    if o == '--stop':
        pid = kaa.utils.is_running('freevo-tvserver')
        if not pid:
            print 'tvserver not running'
            sys.exit(1)
        os.kill(pid, 15)
        sys.exit(0)

    if o in ('--help', '-h'):
        usage(0)
        sys.exit(0)

# load config file
config.load('/etc/freevo/tvserver.conf')
# if started as user add personal config file
if os.getuid() > 0:
    cfgdir = os.path.expanduser('~/.freevo')
    config.load(os.path.join(cfgdir, 'tvserver.conf'))

# save the file again in case it did not exist or the variables changed
config.save()

# check and mark as running
if kaa.utils.is_running('freevo-tvserver'):
    print 'tvserver already running'
    sys.exit(1)

if detach:
    kaa.utils.daemonize()

kaa.utils.set_running('freevo-tvserver')

from freevo.tvserver.rpc import RPCServer
logging.getLogger().setLevel(logging.DEBUG)

# start tvserver
log.setLevel(logging.DEBUG)
server = RPCServer()

kaa.main.run()

# print debug at the end
log.error('terminate')
